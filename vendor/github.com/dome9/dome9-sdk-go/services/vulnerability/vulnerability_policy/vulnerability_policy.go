package vulnerability_policy

import (
	"fmt"
	"net/http"

	"github.com/dome9/dome9-sdk-go/dome9"
	"github.com/dome9/dome9-sdk-go/dome9/client"
)

const (
	vulnerabilityPolicyResourcePath = "vulnerability/policy"
)

type Service struct {
	Client *client.Client
}

func New(c *dome9.Config) *Service {
	return &Service{Client: client.NewClient(c)}
}

type VulnerabilityPolicyRequest struct {
	TargetId                        string   `json:"targetId"`
	TargetType                      string   `json:"targetType"`
	NotificationIds                 []string `json:"notificationIds"`
	RulesetId                       int      `json:"rulesetId"`
	AdmissionControllerAction       string   `json:"admissionControllerAction,omitempty"`
	AdmissionControlUnScannedAction string   `json:"admissionControlUnScannedAction,omitempty"`
}

type VulnerabilityPolicyResponse struct {
	ID                              string   `json:"id"`
	TargetId                        string   `json:"targetId"`
	TargetType                      string   `json:"targetType"`
	NotificationIds                 []string `json:"notificationIds"`
	RulesetId                       int      `json:"rulesetId"`
	AdmissionControllerAction       string   `json:"admissionControllerAction"`
	AdmissionControlUnScannedAction string   `json:"admissionControlUnScannedAction"`
	ErrorMessage                    string   `json:"errorMessage"`
}

func (service *Service) Get(id string) (*VulnerabilityPolicyResponse, *http.Response, error) {
	v := new(VulnerabilityPolicyResponse)
	path := fmt.Sprintf("%s/%s", vulnerabilityPolicyResourcePath, id)
	resp, err := service.Client.NewRequestDoRetry("GET", path, nil, nil, v, shouldRetry)
	if err != nil {
		return nil, nil, err
	}

	return v, resp, nil
}

func (service *Service) GetAll() (*[]VulnerabilityPolicyResponse, *http.Response, error) {
	v := new([]VulnerabilityPolicyResponse)
	resp, err := service.Client.NewRequestDoRetry("GET", vulnerabilityPolicyResourcePath, nil, nil, v, shouldRetry)
	if err != nil {
		return nil, nil, err
	}

	return v, resp, nil
}

func (service *Service) Create(body *VulnerabilityPolicyRequest) (*VulnerabilityPolicyResponse, *http.Response, error) {
	v := new([]VulnerabilityPolicyResponse)
	resp, err := service.Client.NewRequestDoRetry("POST", vulnerabilityPolicyResourcePath, nil, []*VulnerabilityPolicyRequest{body}, v, shouldRetry)
	if err != nil {
		return nil, nil, err
	}
	policy := new(VulnerabilityPolicyResponse)
	if len(*v) > 0 {
		policy = &(*v)[0]
	}
	return policy, resp, nil
}

func (service *Service) Update(body *VulnerabilityPolicyRequest) (*VulnerabilityPolicyResponse, *http.Response, error) {
	v := new([]VulnerabilityPolicyResponse)
	resp, err := service.Client.NewRequestDoRetry("PUT", vulnerabilityPolicyResourcePath, nil, []*VulnerabilityPolicyRequest{body}, v, shouldRetry)
	if err != nil {
		return nil, nil, err
	}
	policy := new(VulnerabilityPolicyResponse)
	if len(*v) > 0 {
		policy = &(*v)[0]
	}
	return policy, resp, nil
}

func (service *Service) Delete(id string) (*http.Response, error) {
	path := fmt.Sprintf("%s/%s", vulnerabilityPolicyResourcePath, id)
	resp, err := service.Client.NewRequestDoRetry("DELETE", path, nil, nil, nil, shouldRetry)
	if err != nil {
		return nil, err
	}

	return resp, nil
}

func shouldRetry(resp *http.Response) bool {
	return resp != nil && resp.StatusCode == http.StatusNotFound
}
